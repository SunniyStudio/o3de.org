---
linkTitle: 第31章 设置多人游戏
title: 第31章 设置多人游戏
description: 第31章 设置多人游戏
---
# 第31章 设置多人游戏
##  Introduction

{{<note>}}
The accompanying source code and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch31_enable_multiplayer_gem
{{</note>}}

Our project has Multiplayer gem enabled, however, more setup is required before we can start writing multiplayer components.

Example 31.1. A lot more is required
```
set(ENABLED_GEMS
  ...
  Multiplayer
)
```

In O3DE writing multiplayer components involves code generation, so we have to add code generation support to gems and projects that will be generating and compiling multiplayer components.

## Enabling Multiplayer Code Generation
In this chapter, we will enable multiplayer component support for MyGem that we have at C:\git\book\Gems\MyGem.

{{<note>}}
For any gems that include multiplayer components, the same steps will be required as well.
{{</note>}}
1. Add code generation files to MyGem.Static build target.

Example 31.2. mygem_autogen_files.cmake
```
set(MPGEMPATH ${LY_ROOT_FOLDER}/Gems/Multiplayer/Code/Include)
set(AUTOPATH ${MPGEMPATH}/Multiplayer/AutoGen)
set(FILES
  ${AUTOPATH}/AutoComponent_Common.jinja
  ${AUTOPATH}/AutoComponent_Header.jinja
  ${AUTOPATH}/AutoComponent_Source.jinja
  ${AUTOPATH}/AutoComponentTypes_Header.jinja
  ${AUTOPATH}/AutoComponentTypes_Source.jinja
)
```

2. Add this list to MyGem.Static CMake target.
```
ly_add_target(
NAME MyGem.Static STATIC
FILES_CMAKE
  mygem_autogen_files.cmake
  ...
```

3. Add code generation rules to MyGem.Static:
```
ly_add_target(
  NAME MyGem.Static STATIC
  ...
  AUTOGEN_RULES
    *.AutoComponent.xml,AutoComponent_Header.jinja,
    $path/$fileprefix.AutoComponent.h
    *.AutoComponent.xml,AutoComponent_Source.jinja,
    $path/$fileprefix.AutoComponent.cpp
    *.AutoComponent.xml,AutoComponentTypes_Header.jinja,
    $path/AutoComponentTypes.h
    *.AutoComponent.xml,AutoComponentTypes_Source.jinja,
    $path/AutoComponentTypes.cpp
)
```

{{<note>}}
Each line of AUTOGEN_RULES should have no line breaks in it. The book format forces line breaks but this portion should actually look like this in your CMakeLists.txt:
```
AUTOGEN_RULES
  *.AutoComponent.xml,Auto...ileprefix.AutoComponent.h
  *.AutoComponent.xml,Auto...ileprefix.AutoComponent.cpp
  *.AutoComponent.xml,Auto...ComponentTypes.h
  *.AutoComponent.xml,Auto...ComponentTypes.cpp
```
Otherwise, you will see odd CMake errors.
{{</note>}}

4. Add dependency on Multiplayer.Static for MyGem.Static. It is needed by multiplayer components.
```
ly_add_target(
  NAME MyGem.Static STATIC
  BUILD_DEPENDENCIES
    PUBLIC
      # For autogen components
      Gem::Multiplayer.Static
      ...
```

5. At this point, CMake build target for MyGem.static should look as follows.

Example 31.3. Completed MyGem.Static with multiplayer enabled
```
ly_add_target(
  NAME MyGem.Static STATIC
  NAMESPACE Gem
  FILES_CMAKE
    mygem_files.cmake
    mygem_autogen_files.cmake
  INCLUDE_DIRECTORIES
    PUBLIC
      Include
    PRIVATE
      Source
  BUILD_DEPENDENCIES
        PUBLIC
            AZ::AzCore
            AZ::AzFramework
            Gem::StartingPointInput.Static
            Gem::LyShine.Static
            Gem::PhysX.Static
            Gem::EMotionFXStaticLib
            # For autogen components
            Gem::Multiplayer.Static
  AUTOGEN_RULES
        *.AutoComponent.xml,Au...refix.AutoComponent.h
        *.AutoComponent.xml,Au...refix.AutoComponent.cpp
        *.AutoComponent.xml,Au...ComponentTypes.h
        *.AutoComponent.xml,Au...ComponentTypes.cpp
 )
```

6.  Add multiplayer component descriptors to the gem. You need one such call for all multiplayer components in a gem.

Example 31.4. Changes to MyGemModuleInterface.h
```
#include <Source/AutoGen/AutoComponentTypes.h>
MyGemModuleInterface()
{
  m_descriptors.insert(m_descriptors.end(), {
    ...
  });
  ...
  //< Register multiplayer components
  CreateComponentDescriptors(m_descriptors);
}
```

{{<note>}}
Some gems do not have a ModuleInterface and instead register component descriptors inside their Module constructors. Either way, you should add CreateComponentDescriptors to where you add component descriptors to AZ::Module's m_descriptors.
{{</note>}}

7. Register components with the Multiplayer system.

Example 31.5. Changes to MyGemSystemcomponent.cpp
```
#include <Source/AutoGen/AutoComponentTypes.h>
void MyGemSystemComponent::Activate()
{
  // Register multiplayer components
  RegisterMultiplayerComponents();
}
```

8. Create multiplayer component XML definitions at C:\git\book\Gems\MyGem\Code \Source\AutoGen. Here is a starting multiplayer component with no C++ code required.

Example 31.6. MyFirstNetworkComponent.AutoComponent.xml
```xml
<?xml version="1.0"?>
<Component
  Name="MyFirstNetworkComponent"
  Namespace="MyGem"
  OverrideComponent="false"
  OverrideController="false"
  OverrideInclude=""
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</Component>
```
9. Include MyFirstNetworkComponent.AutoComponent.xml in the build.

Example 31.7. Changes to Gems\MyGem\Code\mygem_files.cmake
```
set(FILES
  ...
  Source/AutoGen/MyFirstNetworkComponent.AutoComponent.xml # new
)
```

10. Re-compile the gem and the project. If you see a CMake log line similar to the following snippet, you     have successfully configured the gem to support multiplayer components.
```
    2>Generating C:\git\book\build\External\MyGem-409da4e6\
    Code\Azcg\Generated\Source\AutoGen\
    MyFirstNetworkComponent.AutoComponent.h using
    template C:/git/o3de/install/Gems/Multiplayer/
    Code/Include/Multiplayer/AutoGen/AutoComponent_Header.jinja
    and inputs C:\git\book\Gems\MyGem\Code\Source\
    AutoGen\MyFirstNetworkComponent.AutoComponent.xml
```

## Building Installer from Development Branch of O3DE

{{<note>}}
If you are using O3DE 22.05.0 or later, then you can skip this section.
{{</note>}}

In order to get the best experience with multiplayer features of O3DE, we have to get features that were implemented since the release of O3DE Stable 21.11.2. Here are the steps to create a new installer from scratch from https://github.com/o3de/o3de/tree/development.

{{<tip>}}
You can get the latest nightly pre-built installer online at: https://o3debinaries.org/download/windows.html, look for "Nightly Development Build."
{{</tip>}}
1. Clone O3DE repository.
```shell
git clone https://github.com/o3de/o3de
```

{{<note>}}
At the time of writing this book, I tested the rest of the book with development branch at commit b4b7e5a from March 26th, 2022. You can reset to that point with the following git command.
```
git reset --hard b4b7e5a
```
{{</note>}}
2. I will assume that the repository was cloned at c:\git\o3de.
3. Create a build folder at c:\git\o3de\build. 
4. From the build folder, configure CMake.
```
C:\git\o3de\build> cmake -S .. -B .
```
5. Open Visual Studio solution at c:\git\o3de\build\O3DE.sln.
6. Build INSTALL target.

{{<note>}}
This step will take a while, since it builds the entire engine and all the gems.
{{</note>}}
7. The new engine installation will be at c:\git\o3de\install.
8. Open C:\git\o3de\install\engine.json. 
9. Modify engine_name and restricted_name to "o3de-install".
10. Configure python in the new engine.
```
    C:\git\o3de\install> .\python\get_python.bat
```
11. Register the engine.
```
    C:\git\o3de\install> .\scripts\o3de.bat register --this-engine
```
12. Open C:\Users\<user>\.o3de\o3de_manifest.json.
13. Verify that this engine was registered. You should see the following lines.
```
    {
      ...
    "engines": [
      "C:/O3DE/21.11.2",
      "C:/git/o3de/install",
    ],
      ...
    "engines_path": {
      "o3de-sdk": "C:/O3DE/21.11.2",
      "o3de-install": "C:/git/o3de/install",
      ...
    }
```
14. Switch MyProject to use this new engine by modifying C:\git\book\MyPro
    ject\project.json. Change "engine" from "o3de-sdk" to "my-o3de-2111".
```
"engine": "o3de-install"
```
15. Re-compile the project.
16. Re-run Asset Processor. It is going to re-process all the assets.
```
    C:\git\o3de\install\bin\Windows\profile\Default\AssetProcessor.exe
    --project-path C:\git\book\MyProject\
```

Now we can use the latest and greatest features of multiplayer in O3DE!

##  Summary

{{<note>}}
The accompanying source code and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch31_enable_multiplayer_gem
{{</note>}}

We have enabled code generation of multiplayer components for MyGem. Now we are free to start looking at what is the format of *.AutoComponent.xml files, what they generate and what you can do with them in the next chapters.
