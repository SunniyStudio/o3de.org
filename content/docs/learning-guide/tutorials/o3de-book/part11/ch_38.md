---
linkTitle: 第38章 多人游戏动画
title: 第38章 多人游戏动画
description: 第38章 多人游戏动画
---
# 第38章 多人游戏动画
## Introduction

{{<note>}}
The accompanying source code and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch38_multiplayer_animation
{{</note>}}

We have made great strides in converting most of the game logic to multiplayer. The next task is to synchronize the animation of chickens. In single-player, a chicken played a running animation when it moved.

This was broken as we moved to multiplayer, because the client animation component no longer receives any updates of its velocity.

We could fix it by computing velocity of the chicken on a client by singing up to AZ::TransformBus movement notifications but that can lead to issues. For example, a chicken may receive a correction when its player input results disagree with the server. In such a case the chicken might pop back or forward depending on the error, and our velocity calculation will be wrong.

A better approach would be for the server to relay back the velocity to all clients.

## Changes to Chicken Movement Component
We replicated a server value to clients in Chapter 36, Multiplayer Physics, when we needed score values on clients. Now we are going to replicate a velocity field of type AZ::Vector3.
```xml
<NetworkProperty Type="AZ::Vector3" Name="Velocity"
ReplicateFrom="Authority" ReplicateTo="Client"
...
```

Previously we had m_velocity as a member of ChickenMovementComponentController. We are going to replace it with a code generated field, which will give us GetVelocity and SetVelocity methods. Modify the controller's ProcessInput method.
```
void ChickenMovementComponentController::ProcessInput(...)
{
...
GetNetworkCharacterComponentController()->
TryMoveWithVelocity(GetVelocity(), deltaTime);
}
```

Modify the way we save velocity changes.
```
void ChickenMovementComponentController::UpdateVelocity(
const ChickenMovementComponentNetworkInput* input)
{
...
SetVelocity(AZ::Quaternion::CreateRotationZ(currentHeading).
TransformVector(combined) * GetWalkSpeed() +
AZ::Vector3::CreateAxisZ(GetGravity()));
}
```
Enable Generate Event Bindings property.

```
<NetworkProperty Type="AZ::Vector3" Name="Velocity"
GenerateEventBindings="true"
```

This will generate VelocityAddEvent method, which serves as a way to sign up for velocity changes. 

## Chicken Animation Component
In this chapter, we are converting Chicken Animation component to a multiplayer component that will listen for velocity changes from Chicken Movement component on clients where it will apply velocity change to the animation graph.

Figure 38.1. Design of Multiplayer Chicken Animation Component
