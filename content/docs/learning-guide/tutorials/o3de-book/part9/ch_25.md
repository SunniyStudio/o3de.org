---
linkTitle: 第25章 介绍动画
title: 第25章 介绍动画
description: 第25章 介绍动画
---
# 第25章 介绍动画
##  Introduction to EMotionFX
At this point in our game development, the chicken is stuck in idle animation. The next improvement we are going to make is to play walk animation when the chicken is moving and play idle animation when it is not moving.

O3DE comes with an animation gem, EMotionFX. In this chapter, I am going to show you how to build a state machine using EMotionFX to blend between idle and walk animations.

{{<note>}}
The level and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch25_animation
{{</note>}}

## Simple Motion Component
If you do not need to blend animations or other complex animation interaction, you can use Simple Motion component that can play one animation.

Example 25.1. Simple Motion component

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_37.PNG)

This component has various configuration options but we are going to remove it from Chicken_Actor entity and replace it with Anim Graph component.

{{<note>}}
Both Simple Motion and Animation Graph components require an Actor component. Chicken_Actor entity already has one assigned from C:\O3DE\21.11.2\Gems\NvCloth\Assets\Objects\cloth\Chicken\Actor\chicken.fbx. Actor components provide actor mesh and bone information for animations.
{{</note>}}

##  Anim Graph Component
Animation Graph component will allow us to assign an animation graph to the actor and allow us to control the animation using parameters of our choice.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_38.PNG)

When you first add this component, its fields are empty. First, we have to create an Anim graph asset. Open Animation Editor either through the main menu Tools → Animation Editor or by clicking on the right most icon next to Anim graph property on the component.

## Building an Animation Graph
{{<tip>}}
Animation Editor should open with an empty workspace. If not, reset it with File → New Workspace.
{{</tip>}}

An animation graph is a collection of various nodes that define the logic and behavior of animations and their interactions, such as blending multiple animations together. At a high level, we are going to build a state machine that blends between idle motion from chickenidle.fbx and walking motion from chickenwalking.fbx. Both files come with NvCloth gem in O3DE installation at C:\O3DE \21.11.2\Gems\NvCloth\Assets\Objects\cloth\Chicken\Motions.

### Assign Preview Actor
To give us a visual guidance as we work on an animation graph, load an actor into Animation Editor.
1. Go to Actor Manager tab. (If it is not open, use the main menu: View → Actor Manager.)
2. Click on the folder icon.
3. Choose Load actor

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_39.PNG)

4.  Choose chicken.actor from NvCloth gem's location. That will load the chicken actor into OpenGL Render Window. It will serve as a testing ground for the animation graph.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_40.PNG)

### Test Motions
Before we spend time building out the graph, test that the motion works with chicken.
1. Go to Motions tab, View → Motions. 
2. Click on plus "+" icon. 
3. Pick Emotion FX Motion dialog will open, select chickenidle.motion.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_41.PNG)

5. In the list of motions, double click on chickenidle to test the motion. 
6. Repeat the steps for chickenwalking.motion.

7. That will play the animations in OpenGL Render Window to let you see how the animation look and if they match the actor.

##  Create a Motion Set
Before we get into building the animation graph, we need to create a motion set to hold the collection of the motions we are going to use.

1. Go to Motion Sets tab, if it is not open use View → Motions Sets.
2. Click on plus "+" icon to create a new motion set, MotionSet0.
3. In Motion Set section, there is folder icon, click it and select chickenidle.motion

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_42.PNG)

{{<tip>}}
You can double click the motion chickenidle to test it in the render window
{{</tip>}}

4. Repeat the steps for chickenwalking.motion. 
5. Save the motion set using floppy disk icon. For example, I saved it to C:\git\book\Gems\MyGem\Assets\Animation\chicken.motionset.

### Anim Graph
We are ready to start building an animation graph that will blend walking and idle motions.
1. Go to Anim Graph tab, if it is not open use View → Anim Graph.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_43.PNG)

2.  Click on plus "+" icon to create a new empty Animgraph.
3. In empty work space of Anim Graph, right
click and choose Create Node → Sources →
BlendTree.

{{<tip>}}
You can also drag and drop BlendTree node
from Anim Graph Palette's Sources group.
{{</tip>}}

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_44.PNG)

4. Double click on the BlendTree0 node to see its configuration. By default, a blend tree has a final node and nothing else. This node will receive the blend of two motions.

{{<tip>}}
You can rename node names in Attributes
panel.
{{</tip>}}

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_45.PNG)

5. Add Blend Two node to the left of FinalNode0 with right click → Create Node → Blending → BlendTwo. This node will blend two motions together and assign the result into FinalNode0.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_46.PNG)

6. To the left of BlendTwo0, create two Motion nodes, with Create Node → Sources → Motion.
7. Select Motion0 node.
8. Go to Attributes panel.
9. To the right of Motions property, click on plus "+" button.
10. Motion Selection Window will open, select chickenidle motion from MotionSet0.
11. For Motion1 node, select chickenwalking motion in the same manner.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_47.PNG)

12.  On Motion nodes, there is Output Pose output. Drag a line from the square next to Output Pose to Pose 1 input on BlendTwo0 node.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_48.PNG)

13. Connect Outpost Pose of BlendTwo0 node with FinalNode0's Input Pose. The animation graph should start to play. If not, there is a white arrow play button in Anim Graph's toolbar.

## Animation Blending
Figure 25.1. First Blending of Two Animations

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_49.PNG)

Let us take a look at what is going on. We created a blend node. Inside the node, we declared two motion sources that are blended together with Blend Two node, which outputs the result into final node. At the  moment, the only motion that is actually playing is the idle motion. This is because Weight input of BlendTwo0 node determines the amount of blending between the two motions.

Since we are blending between idle and walking motions, it would make sense to blend it based on the speed of the chicken. If the speed is zero, it should play idle motion. As the chicken starts to move the  anim graph should blend between the two motions until playing only the walking motion.

### Parameters
To control the blending, we will add a parameter that we can specify from outside of the animation graph.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_50.PNG)

There is a C++ API to do so from a component but before we get to that, we will create a parameter and test it inside the Animation Editor.
1. Go to Parameters window, using View → Parameter Window if it is not open.
2. Click on plus "+" icon.
3. Choose Add parameter.
4. For Name, enter "Speed".
5. For Maximum, enter six (6.0), since the maximum speed of the chicken was set to 6 in Chapter 18, Character Movement.
6.  Click "Create" to create the parameter.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_51.PNG)

Speed parameter
7. In Anim graph space, choose Create Node → Sources → Parameters.
8. With Parameters0 node selected, go to Attributes panel and click on Select parameters.
9. Choose Speed parameter.

{{<note>}}
Our speed parameter range was set to be between zero and six. But the Weight input value of BlendTwo0 takes a range from zero to one. We have to remap the range to match Weight requirements using Range Remapper node.
{{</note>}}

10. Create Node → Math → Smoothing.

{{<tip>}}
    Smoothing node is optional but it lets us smoothly raise the value of a parameter and thus blend    between the motions over time without doing this work in a C++ component. However, if you need precise control over the animation output, you will have to drive the Speed parameter your
    self.
{{</tip>}}
11. Create Node → Math → Range Remapper.
12. With RangeRemapper0 node selected, go to Attributes panel and change Input Max to six (6) to match     the range of Speed parameter.
13. Connect Parameters0 to Smoothing0, Smoothing0 to RangeRemapper0 and RangeRemapper0 to Weight input of BlendTwo0.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_52.PNG)

14. Now you can test the animation graph by changing Speed parameter value.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_53.PNG)

15. Save the anim graph as C:\git\book\Gems\MyGem\Assets\Animation\chicken.animgraph.
16. Save the workspace as C:\git\book\Gems\MyGem\Assets\Animation\chicken.emfxworkspace.

### Motion Adjustments
We have a walking animation for the chicken but it is too slow for our gameplay. We can fix that up speeding up the play speed of the walking animation.
1. Go to Motion1 node that has chickenwalking.motion assigned.
2. In Attributes panel, change Play Speed to three (3).
3. Test the look of the animation by modifying Speed parameter.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_54.PNG)

4. Save the animation graph.

## Assigning the Anim Graph
At this point, we are done with Animation Editor, going back to Editor, we can assign the new graph in Anim Graph component.
1. Set Anim graph to chicken.animgraph.
2. Set Motion set asset to chicken.motionset.
3. "Action motion set" property will update to MotinoSet0 on its own after you set the motion set.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_55.PNG)

{{<note>}}
Anim Graph component reads the animation graph we assigned, finds Speed parameter and reflects it to the Editor. You can test the animation again by manually entering the value on the component and playing the level with CTRL+G
{{</note>}}

##  Driving Speed Parameter
The only work left for us is to set Speed parameter based on the chicken's speed. This can be done by calculating the speed of our chicken and then calling SetNamedParameterFloat.

```c++
using namespace EMotionFX::Integration;
AnimGraphComponentRequestBus::Event(m_actor,
&AnimGraphComponentRequests::SetNamedParameterFloat,
"Speed", s);
```

In order to separate concerns from other components we have written so far, I have created a new component, ChickenAnimationComponent that receives speed notifications via ChickenNotificationBus from ChickenControllerComponent.

```c++
void ChickenControllerComponent::UpdateVelocity(
 const ChickenInput& input)
    {
 ...
        ChickenNotificationBus::Event(GetEntityId(),
            &ChickenNotificationBus::Events::OnChickenSpeedChanged,
            m_velocity.GetLength());
    }
```

OnChickenSpeedChanged will assign the Speed parameter and finish the work for this chapter.

```c++
void ChickenAnimationComponent::OnChickenSpeedChanged(float s)
    {
 using namespace EMotionFX::Integration;
        AnimGraphComponentRequestBus::Event(m_actor,
            &AnimGraphComponentRequests::SetNamedParameterFloat,
 "Speed", s);
    }
```

Example 25.2. Chicken Running at the Ball

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_56.PNG)

## Source Code

{{<note>}}
The level and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch25_animation

{{</note>}}

Example 25.3. ChickenBus.h
```c++
 #pragma once
 #include <AzCore/Component/ComponentBus.h>
 namespace MyGem
 {
 class ChickenNotifications
        : 
public AZ::ComponentBus
    {
 public:
 virtual void OnChickenSpeedChanged(float speed) = 0;
    };
 using ChickenNotificationBus = AZ::EBus<ChickenNotifications>;
 }
```
Example 25.4. ChickenAnimationComponent.h
```c++
#pragma once
 #include <AzCore/Component/Component.h>
 #include <MyGem/ChickenBus.h>
 namespace MyGem
 {
 class ChickenAnimationComponent
        : 
public AZ::Component
        , 
public ChickenNotificationBus::Handler
    {
 public:
        AZ_COMPONENT(ChickenAnimationComponent,
 "{ED8B6A79-AA47-44B2-91B6-64A78439B037}");
 static void Reflect(AZ::ReflectContext* rc);
 // AZ::Component interface implementation
 void Activate() override;
 void Deactivate() override;
 // ChickenNotificationBus interface
 void OnChickenSpeedChanged(float s) override;
 private:
        AZ::EntityId m_actor;
    };
 } // namespace MyGem
```
Example 25.5. ChickenAnimationComponent.h
```c++
#include <ChickenAnimationComponent.h>
 #include <AzCore/Serialization/EditContext.h>
 #include <Integration/AnimGraphComponentBus.h>
 namespace MyGem
 {
 void ChickenAnimationComponent::Reflect(AZ::ReflectContext* rc)
    {
 if (auto sc = azrtti_cast<AZ::SerializeContext*>(rc))
        {
            sc->Class<ChickenAnimationComponent, AZ::Component>()
              ->Field("Actor", &ChickenAnimationComponent::m_actor)
              ->Version(1);
 if (AZ::EditContext* ec = sc->GetEditContext())
            {
 using namespace AZ::Edit;
                ec->Class<ChickenAnimationComponent>(
 "Chicken Animation",
 "[Player controlled chicken]")
                    ->ClassElement(ClassElements::EditorData, "")
                    ->Attribute(
                        Attributes::AppearsInAddComponentMenu,
                            AZ_CRC_CE("Game"))
                    ->DataElement(nullptr,
                        &ChickenAnimationComponent::m_actor,
 "Actor", "Entity with chicken actor.");
            }
        }
    }
 void ChickenAnimationComponent::Activate()
    {
        ChickenNotificationBus::Handler::BusConnect(GetEntityId());
    }
 void ChickenAnimationComponent::Deactivate()
    {
        ChickenNotificationBus::Handler::BusDisconnect();
    }
 void ChickenAnimationComponent::OnChickenSpeedChanged(float s)
    {
 using namespace EMotionFX::Integration;
        AnimGraphComponentRequestBus::Event(m_actor,
            &AnimGraphComponentRequests::SetNamedParameterFloat,
 "Speed", s);
    }
 } // namespace MyGem
```
