---
linkTitle: 第26章 动画状态机
title: 第26章 动画状态机
description: 第26章 动画状态机
---
# 第26章 动画状态机
##  Introduction

{{<note>}}
The level and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch26_animation_statemachine
{{</note>}}

Building on Chapter 25, Introduction to Animation, we are going to add a chicken animation to celebrate scoring a goal using chicken flapping motion. This will involve building a state machine inside Animation Editor, defining transitions and parameter actions.

Figure 26.1. Animation State Machine

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_57.PNG)

##  Adding Flapping Motion
1. Open Animation Editor from Anim Graph component with chicken.animgraph.
2. Go to Motions Sets.
3. For MotionSet0, add chickenflapping.motion from C:\O3DE\21.11.2\Gems
\NvCloth\Assets\Objects\cloth\Chicken\Motions.
4. Save the motion set.

## Adding Celebration Blend Tree
1. Add a Boolean (checkbox) parameter and name it "Celebrating". When the value of this parameter is set to true, the chicken will play a flapping motion to celebrate scoring a goal.
2. Set the default value of the parameter to false.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_58.PNG)

3. There is only one blend tree in the animation graph. Rename it to Playing BlendTree, so that we can  distinguish it from the second new blend tree node that we are about to add

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_59.PNG)

4. Create Node → Sources → Blend Tree. 
5. Rename it to "Celebration BlendTree". 
6. Double click Celebration Blend Tree. 
7. Create Node → Sources → Motion.

{{<note>}}
When we were blending idle and walking motion we used a Blend Two node. However, for celebration motion we do not need to do any blending. We just want the chicken to play the flapping motion.
{{</note>}}

8. Rename the new motion node to Celebration Motion.
9. With the motion node selected, in Attributes panel, under Motions, assign chickenflapping motion from C:\O3DE\21.11.2\Gems\NvCloth\Assets\Objects\cloth\Chick
en\Motions.
10. Connect Output Pose of Celebration Motion with Input Pose of FinalNode1.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_60.PNG)

11. Go back up a level.
12. Left click and drag an arrow from Playing Blend Tree to Celebration Blend Tree.

{{<tip>}}
In order to draw an arrow, left click closer to the edge of a node away from its name. If you hover your mouse over the node and slowly move it up, you will see the mouse pointer change its look    that will indicate when the location will select the node or start creating an arrow.
{{</tip>}}

Figure 26.2. Adding a Transition between Blend Trees

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_61.PNG)

13. Select the arrow.

{{<note>}}
We are now going to add a condition when one blend tree will transition to the other one.
{{</note>}}

14. With the arrow selected, in Attributes panel, choose Add condition and then Parameter Condition.
15. Using "Select parameter" button, select Celebrating parameter.
16. For "Test Function", select equality condition.
17. For "Test value", set the value of one (1.0).

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_62.PNG)

{{<note>}}
A boolean value of "true" is treated as the value of one (1.0) by Animation Editor in parameter conditions.
{{</note>}}

18. That creates a condition to transition from "Playing Blend Tree" to "Celebration Blend Tree" when Celebrating parameter is set to true.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_63.PNG)

{{<note>}}
Next step is to define when we exit the celebration state and reset Celebrating parameter back to false.
{{</note>}}

19. Left click and drag an arrow from Celebration Blend Tree to Playing Blend Tree.
20. Select the new arrow.
21. In Attributes panel, select Add condition, choose State Condition. This will add State Condition to    the Attributes panel.
22. Under State, user Select node button to choose Celebration Motion node.
23. For Test Function, select "Has Reached Specified Playtime."
24. For Play Time, enter 2.0.

{{<note>}}
    The units for Play Time is seconds. If you take a look at "chicken flapping" motion under Motions     tab, you will find that it is 2.47 seconds long. However, it has some idle time at the end of it, so    I chose to transition away before the end of the motion.
{{</note>}}

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_64.PNG)

25. Now choose Add action in the same Attributes panel with the arrow still selected.

26. Choose Parameter Action.
27. Keep Trigger Mode as "On Enter."
28. For Parameter, select Celebration parameter.
29. For Trigger Value, keep 0.0. This creates an action of setting Celebration parameter value to zero     (false for boolean parameters) when the selected transition occurs.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_65.PNG)

Change Parameter Value

With these changes, we now have a state machine that switches between celebrating motion and blending between idle and walking motion.

Figure 26.3. Animation State Machine

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_66.PNG)

You can test this logic by setting Celebrating parameter to enabled and then watch chicken celebration motion play for two seconds and then switch back to Player Blend Tree while setting Celebrating value  back to false.

Figure 26.4. List of Parameters

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_67.PNG)

Once you save the changes in the animation graph, Anim Graph component will update the list of parameters to reveal Celebrating boolean parameter.

Figure 26.5. Anim Graph component with updated parameters

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_68.PNG)

##  Summary
In this chapter, we enhanced the animation graph to add celebration motion and tested it in the Animation Editor. We know it works but there is no game logic to trigger it. We can do it by adding logic to a C++ component as we did in the previous chapter. However, we have already done that before, so in the next chapter I will show you how to do it using Script Canvas, the visual scripting in O3DE.

{{<note>}}
The assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch26_animation_statemachine
{{</note>}}
