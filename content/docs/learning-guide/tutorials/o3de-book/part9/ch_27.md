---
linkTitle: 第27章 ScriptCanvas
title: 第27章 ScriptCanvas
description: 第27章 ScriptCanvas
---
# 第27章 ScriptCanvas
## Introduction

{{<note>}}
The assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch27_scriptcanvas
{{</note>}}

Our goal for this chapter is to have the chicken celebrate each goal with a flapping motion. We created the animation graph to support that animation. We need to set 'Celebrating' animation parameter to true whenever a goal is scored. We could do it with C++ but this is a good opportunity to show you how to do the same work using visual scripting.

Script Canvas is a visual scripting tool in O3DE. For example, here is a visual node that is equivalent to the C++ method of SetNamedParameterBool, a similar method to what we used in earlier chapters.

Example 27.1. Set Named Parameter Bool

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_69.PNG)

As a reminder, GoalDetectorComponent sends out notifications when a goal is scored.
```c++
void GoalDetectorComponent::UpdateUi()
{
  UiScoreNotificationBus::Broadcast(
  &UiScoreNotificationBus::Events::OnTeamScored, m_team);
}
```

We need to sign up to receive this event and set Celebration parameter on Anim Graph component to true.

## Behavior Context
In order for Script Canvas to provide you with a node for a new custom notification EBus, we have to reflect that EBus to Behavior Context. Here are the steps to reflect a notification bus.

1. Here is the bus we are reflecting.
```c++
class UiScoreNotifications
: 
public AZ::ComponentBus
{
public:
virtual void OnTeamScored(int team) = 0;
};
using UiScoreNotificationBus = AZ::EBus<UiScoreNotifications>;
```

2. Create a behavior handler for it.
```c++
class ScoreNotificationHandler
```

3. Inherit from the EBus you are looking to reflect to scripting and from AZ::BehaviorEBusHandler.
```c++
class ScoreNotificationHandler
: public UiScoreNotificationBus::Handler
, public AZ::BehaviorEBusHandler
```

4. List all the methods you are looking to reflect with AZ_EBUS_BEHAVIOR_BINDER macro. In this case, there is only OnTeamScored.
```c++
AZ_EBUS_BEHAVIOR_BINDER(ScoreNotificationHandler,
"{33B5BC25-622B-4DF0-92CF-987CC6108C31}",
AZ::SystemAllocator,
OnTeamScored);
```

{{<tip>}}
If there were more methods to reflect you would list them after one at a time at the end of the macro.
```c++
AZ_EBUS_BEHAVIOR_BINDER(ScoreNotificationHandler,
  "{33B5BC25-622B-4DF0-92CF-987CC6108C31}",
  AZ::SystemAllocator,
  Method1,
  Method2,
  Method3);
```
{{</tip>}}

5. Override each method to call FN_<method name> methods that are generated by AZ_EBUS_BEHAVIOR_BINDER. For example, there is FN_OnTeamScored for OnTeamScored .
```c++
void OnTeamScored(int team) override
{
  Call(FN_OnTeamScored, team);
}
```

6. Register this handler with BehaviorContext. It can be done in any Reflect method. For example, in GoalDetectorComponent. It is a good spot, since it invokes an event on it. Another good option is to put it inside a system component of your gem or project.
```c++
void GoalDetectorComponent::Reflect(AZ::ReflectContext* rc)
{
 //...
 if (auto bc = azrtti_cast<AZ::BehaviorContext*>(rc))
    {
        bc->EBus<UiScoreNotificationBus>("ScoreNotificationBus")
            ->Handler<ScoreNotificationHandler>();
    }
 }
```

{{<tip>}}
If you are reflecting a method to call from Script Canvas into C++, it takes just a few lines of code in C++. For example, here is the reflection for SetNamedParameterBool that we saw in the beginning of this chapter.
```c++
behaviorContext->EBus<AnimGraphComponentRequestBus>(
"AnimGraphComponentRequestBus")
> Event("SetNamedParameterBool",
> &AnimGraphComponentRequestBus::Events::SetNamedParameterBool)
```
 You can see this definition here: C:\git\o3de\Gems\EMotionFX\Code\Source\Integration\Components\AnimGraphComponent.cpp.
{{</tip>}}

##  Building a Canvas
Once the project is compiled, you can re-open the Editor and create a new script canvas. Here are the steps to set Celebration parameter from Script Canvas.
1. Go to Chicken_Actor entity. (It has Anim Graph component on it.)
2. Add Script Canvas component to the entity. 
3. Open Script Canvas editor using Tools → Script Canvas or from the icon on Script Canvas component. 
4. Once inside Script Canvas editor, start a new script with File → New Script. 
5. In Node Pallete, search for "Score Notification Bus."

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_70.PNG)

6. Drag and drop OnTeamScored into empty canvas space.
7. Search for "Set Named Parameter Bool" in Node Palette. Drag and drop it into the canvas as well.

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_71.PNG)

8. Connect the execution line from OnTeamScored to the In execution connector on "Set Named Parameter Bool" node. The notification node will start the execution of the script when an event is invoked. The execution will be passed to "Set Named Parameter Bool" node. Afterwards the Out connector will pass the execution to the next node if one is connected.

Figure 27.1. Two Script Canvas Nodes

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_72.PNG)

9. On "Set Named Parameter Bool" node, set Value to Celebrating.
10. Set Boolean value to checked.
11. Save the canvas under the project or one of the gems, for example at C:\git\book\MyPro
    ject\scriptcanvas\celebrate.scriptcanvas.
12. Go back to Chicken_Actor entity.
13. On Script Canvas component, assign the new canvas to Script Canvas Source File property.

Example 27.2. Chicken_Actor entity with Script Canvas component

![](/images/learning-guide/tutorials/o3de-book/Part9/o3de_book_9_73.PNG)

With this component, anytime a goal is scored the chicken will play celebration flapping motion for two seconds.

##  Summary

{{<note>}}
The source code and assets for this chapter can be found on GitHub at:
https://github.com/AMZN-Olex/O3DEBookCode2111/tree/ch27_scriptcanvas
{{<note>}}

Here are C++ code changes in this chapter.

Example 27.3. New code in GoalDetectorComponent.cpp
```c++
 void GoalDetectorComponent::Reflect(AZ::ReflectContext* rc)
    {
 //...
 if (auto bc = azrtti_cast<AZ::BehaviorContext*>(rc))
        {
            bc->EBus<UiScoreNotificationBus>("ScoreNotificationBus")
                ->Handler<ScoreNotificationHandler>();
        }
    }
```

Example 27.4. UiScoreBus.h
```c++
 #pragma once
 #include <AzCore/Component/ComponentBus.h>
 #include <AzCore/RTTI/BehaviorContext.h>
 namespace MyGem
 {
 class UiScoreNotifications
        : 
public AZ::ComponentBus
    {
 public:
 virtual void OnTeamScored(int team) = 0;
    };
 using UiScoreNotificationBus = AZ::EBus<UiScoreNotifications>;
 /// NEW
 class ScoreNotificationHandler
        : 
        , 
public UiScoreNotificationBus::Handler
 public AZ::BehaviorEBusHandler
    {
 public:
        AZ_EBUS_BEHAVIOR_BINDER(ScoreNotificationHandler,
 "{33B5BC25-622B-4DF0-92CF-987CC6108C31}",
            AZ::SystemAllocator, OnTeamScored);
 void OnTeamScored(int team) override
        {
            Call(FN_OnTeamScored, team);
        }
    };
 }
```
{{<note>}}
You can find documentation on how to reflect various classes, structures and interfaces to Behavior Context at: https://docs.o3de.org/docs/user-guide/programming/components/reflection/behavior-context/
{{</note>}}
